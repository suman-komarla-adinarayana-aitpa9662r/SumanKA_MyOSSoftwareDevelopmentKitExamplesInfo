/**********************************************************************************************************************
 * \file Uart.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "Uart.h"
#include "IfxAsclin_Asc.h"
#include "IfxCpu_Irq.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
#define UART_BAUDRATE       115200                                  /* UART baud rate in baud                       */

#define UART_PIN_RX         IfxAsclin0_RXA_P14_1_IN                 /* UART receive port pin                        */
#define UART_PIN_TX         IfxAsclin0_TX_P14_0_OUT                 /* UART transmit port pin                       */

#define UART_INT_PRIO_RX    (4)                                     /* Define the ASC0 receive interrupt priority   */
#define UART_INT_PRIO_TX    (8)                                     /* Define the ASC0 transmit interrupt priority  */
#define UART_INT_PRIO_ER    (12)                                    /* Define the ASC0 error interrupt priority     */

/** Timeout after which the BB protocol discards the frame */
#define BB_REMOTE_TIMEOUT   (1000)

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/
static IfxAsclin_Asc       g_uart;                                  /* UART driver                                  */
static IfxStdIf_DPipe      g_uartPipe;                              /* UART standard pipe interface                 */
static Ifx_Oe_SyncProtocol g_bb;                                    /* SyncProtocol driver                          */

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/
/* Adding of the interrupt service routines */
IFX_INTERRUPT(uartTxIsr, 0, UART_INT_PRIO_TX);
void uartTxIsr(void)
{
    IfxAsclin_Asc_isrTransmit(&g_uart);
}

IFX_INTERRUPT(uartRxIsr, 0, UART_INT_PRIO_RX);
void uartRxIsr(void)
{
    IfxAsclin_Asc_isrReceive(&g_uart);
}

IFX_INTERRUPT(uartErIsr, 0, UART_INT_PRIO_ER);
void uartErIsr(void)
{
    IfxAsclin_Asc_isrError(&g_uart);
}

/* This function initializes the ASCLIN UART module */
Ifx_Oe_SyncProtocol* initUart(void)
{
    /* Initialize an instance of IfxAsclin_Asc_Config with default values */
    IfxAsclin_Asc_Config ascConfig;
    IfxAsclin_Asc_initModuleConfig(&ascConfig, UART_PIN_TX.module);

    /* Set the desired baud rate */
    ascConfig.baudrate.baudrate             = UART_BAUDRATE;
    ascConfig.baudrate.oversampling         = IfxAsclin_OversamplingFactor_16;
    ascConfig.bitTiming.medianFilter        = IfxAsclin_SamplesPerBit_three;
    ascConfig.bitTiming.samplePointPosition = IfxAsclin_SamplePointPosition_8;

    /* ISR priorities and interrupt target */
    ascConfig.interrupt.txPriority    = UART_INT_PRIO_TX;
    ascConfig.interrupt.rxPriority    = UART_INT_PRIO_RX;
    ascConfig.interrupt.erPriority    = UART_INT_PRIO_ER;
    ascConfig.interrupt.typeOfService = IfxCpu_Irq_getTos(IfxCpu_getCoreIndex());

    /* FIFO configuration */
    ascConfig.txBufferSize = Ifx_Oe_SyncProtocol_getFifoSize();
    ascConfig.rxBufferSize = Ifx_Oe_SyncProtocol_getFifoSize();

    /* Pin configuration */
    const IfxAsclin_Asc_Pins pins =
    {
        .cts       = NULL_PTR,
        .ctsMode   = IfxPort_InputMode_noPullDevice,
        .rx        = &UART_PIN_RX,
        .rxMode    = IfxPort_InputMode_noPullDevice,
        .rts       = NULL_PTR,
        .rtsMode   = IfxPort_OutputMode_pushPull,
        .tx        = &UART_PIN_TX,
        .txMode    = IfxPort_OutputMode_pushPull,
        .pinDriver = IfxPort_PadDriver_cmosAutomotiveSpeed1
    };
    ascConfig.pins = &pins;

    /* Initialize module with above parameters */
    IfxAsclin_Asc_initModule(&g_uart, &ascConfig);

    /* Initialize the standard interface for the UART */
    IfxAsclin_Asc_stdIfDPipeInit(&g_uartPipe, &g_uart);

    /* Initialize the BB protocol */
    Ifx_Oe_SyncProtocol_init(&g_bb, BB_REMOTE_TIMEOUT, &g_uartPipe);

    return &g_bb;
}


void processUart(void)
{
    /* Process the BB protocol */
    Ifx_Oe_SyncProtocol_execute(&g_bb);
}
