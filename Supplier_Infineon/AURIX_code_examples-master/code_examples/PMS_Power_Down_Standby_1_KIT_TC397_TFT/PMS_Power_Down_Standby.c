/**********************************************************************************************************************
 * \file PMS_Power_Down_Standby.c
 * \copyright Copyright (C) Infineon Technologies AG 2019
 *
 * Use of this file is subject to the terms of use agreed between (i) you or the company in which ordinary course of
 * business you are acting and (ii) Infineon Technologies AG or its licensees. If and as long as no such terms of use
 * are agreed, use of this file is subject to following:
 *
 * Boost Software License - Version 1.0 - August 17th, 2003
 *
 * Permission is hereby granted, free of charge, to any person or organization obtaining a copy of the software and
 * accompanying documentation covered by this license (the "Software") to use, reproduce, display, distribute, execute,
 * and transmit the Software, and to prepare derivative works of the Software, and to permit third-parties to whom the
 * Software is furnished to do so, all subject to the following:
 *
 * The copyright notices in the Software and this entire statement, including the above license grant, this restriction
 * and the following disclaimer, must be included in all copies of the Software, in whole or in part, and all
 * derivative works of the Software, unless such copies or derivative works are solely in the form of
 * machine-executable object code generated by a source language processor.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
 * WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
 * COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *********************************************************************************************************************/

/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "PMS_Power_Down_Standby.h"
#include "IfxPort.h"
#include "IfxScuWdt.h"
#include "IfxPms_reg.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/
#define LED_D110                            &MODULE_P13,3   /* LED that signals the start of the application        */
#define LED_D107                            &MODULE_P13,0   /* LED that signals the entering in Standby mode        */
#define TICKS_TO_WAIT                       0x8000000       /* Total amount of ticks in approximately one second    */
#define MASK_BIT2_TO_8_ONES                 0x1FC           /* Mask to clear all Standby and Wake-up flags          */
#define WAKEUP_PINA_ENABLE                  0x1
#define WAKEUP_PORST_ENABLE                 0x1
#define TRIGGER_ON_ANY_EDGE                 0x3             /* Bits to configure the wake-up trigger on any edge    */
#define DISABLE_WAKEUP_ON_ESR0              0x0
#define DISABLE_WAKEUP_ON_VEXT_RAMPUP       0x0
#define REQUEST_STANDBY                     0x3             /* Standby Mode request bits for the system             */

/*********************************************************************************************************************/
/*------------------------------------------------Function Implementations-------------------------------------------*/
/*********************************************************************************************************************/
/* This function configure the LEDs */
void initLEDs(void)
{
    /* Set Port Pin 13.3 and 13.0 to output mode */
    IfxPort_setPinModeOutput(LED_D110, IfxPort_OutputMode_pushPull, IfxPort_OutputIdx_general);
    IfxPort_setPinModeOutput(LED_D107, IfxPort_OutputMode_pushPull, IfxPort_OutputIdx_general);
}

/* This function put the system into Standby after a few seconds */
void runStandby(void)
{
    IfxPort_setPinLow(LED_D110);                                          /* Set Port Pin 13.3 to high - D110 on    */
    IfxPort_setPinHigh(LED_D107);                                         /* Set Port Pin 13.0 to high - D107 off   */

    for(uint32 i = 4 * TICKS_TO_WAIT; i > 0; i--);                        /* Wait for ~4s                           */

    IfxPort_setPinLow(LED_D107);                                          /* Set Port Pin 13.0 to high - D107 on    */

    for(uint32 i = TICKS_TO_WAIT; i > 0; i--);                            /* Wait for ~1s                           */

    stepIntoStandbyMode();                                                /* Put the system into Standby            */
}

/* This function put the system into Standby */
void stepIntoStandbyMode(void)
{
    IfxScuWdt_clearSafetyEndinit(IfxScuWdt_getSafetyWatchdogPassword());  /* Clear Safety EndInit protection        */
    IfxScuWdt_clearCpuEndinit(IfxScuWdt_getCpuWatchdogPassword());        /* Clear CPU EndInit protection           */

    MODULE_PMS.PMSWSTATCLR.U = MASK_BIT2_TO_8_ONES;                       /* Clear all Standby and Wake-up flags    */

    Ifx_PMS_PMSWCR0 pmswcr0;                                              /* Stdby and Wake-up Ctrl Reg 0 handle    */
    pmswcr0.U = MODULE_PMS.PMSWCR0.U;                                     /* Assign current register value to it    */
    pmswcr0.B.PINAWKEN  = WAKEUP_PINA_ENABLE;                             /* Enable WakeUp on Pin A                 */
    pmswcr0.B.PORSTWKEN = WAKEUP_PORST_ENABLE;                            /* Enable WakeUp on PORST                 */
    pmswcr0.B.PINAEDCON = TRIGGER_ON_ANY_EDGE;                            /* Generate WakeUp Trigger at any edge    */
    pmswcr0.B.ESR0EDCON = DISABLE_WAKEUP_ON_ESR0;                         /* Disable WakeUpTrigger at any ESR0 edge */
    pmswcr0.B.PWRWKEN   = DISABLE_WAKEUP_ON_VEXT_RAMPUP;                  /* Disable WakeUpTrigger on VEXT ramp up  */
    MODULE_PMS.PMSWCR0.U = pmswcr0.U;                                     /* Assign object to register              */

    SCU_PMCSR0.B.REQSLP = REQUEST_STANDBY;                                /* Request Standby Mode for the system    */

    IfxScuWdt_setSafetyEndinit(IfxScuWdt_getSafetyWatchdogPassword());    /* Set Safety EndInit protection          */
    IfxScuWdt_setCpuEndinit(IfxScuWdt_getCpuWatchdogPassword());        /* Set CPU EndInit - Standby becomes active */
}
